<!DOCTYPE html>
<html>
    <head><title>Actually pnacl</title>
    <link rel="stylesheet" type="text/css" href="mystyle.css"></head>
    <body>
        <embed
            id="pnacl"
            width="200" height="200"
            src="pnacl/Debug/hello_tutorial.nmf"
            type="application/x-pnacl"
            ps_stdout="dev/tty"
            ps_tty_prefix=""
            arg0="rtsp://192.168.1.52:8554/desktop"
        ></embed>
        <!-- arg0="rtsp://184.72.239.149/vod/mp4:BigBuckBunny_115k.mov" rtsp://192.168.1.52:8554/desktop  rtsp://dmzosx001.dpa.act.gov.au/medium-->
        <!--1018x700 240x160 960x640 1163x800-->
        <canvas id="canvas" width="1018" height="700"></canvas>
        <pre id="output"></pre>
        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec4 vertex;
            varying vec2 tc;
            void main(){
                gl_Position = vertex;
                tc = vertex.xy*0.5+0.5;
            }
        </script>
        <script id="shader-fs" type="x-shader/x-fragment">
            precision highp float;
            uniform sampler2D tex;
            varying vec2 tc;
            void main(){
                gl_FragColor = texture2D(tex, tc);
            }
        </script>


        <script>
            var output = document.getElementById("output");
            var pnacl = document.getElementById("pnacl");

            function yuv2rgb(y,u,v){
              y=parseInt(y);
              u=parseInt(u);
              v=parseInt(v);
              r=clamp(Math.floor(y+1.4075*(v-128)),0,255);
              g=clamp(Math.floor(y-0.3455*(u-128)-(0.7169*(v-128))),0,255);
              b=clamp(Math.floor(y+1.7790*(u-128)),0,255);
              return({r:r,g:g,b:b});
            }

            function clamp(n,low,high){
                if(n<low){return(low);}
                if(n>high){return(high);}
            }

            function convert(){

            }

            function log_handler(tag) {
                return function () {
                    var args = [tag].concat(Array.prototype.slice.call(arguments));
                    console.log.apply(console, args);
                }
            }
            //240x160 1018x700 320x240 1024x706
            var w = 1018;
            var h = 700;
            var cv = document.getElementById('canvas');
            var gl = cv.getContext('experimental-webgl');
            var tex = gl.createTexture();
            var vbo = gl.createBuffer();
            var program = gl.createProgram();
            var fragmentShader = getShader(gl, "shader-fs");
            var vertexShader = getShader(gl, "shader-vs");
            program.fs = fragmentShader;
            program.vs = vertexShader;
            var view;
            gl.bindTexture(gl.TEXTURE_2D, tex);
            //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
            //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
            gl.attachShader(program,program.vs);
            gl.attachShader(program,program.fs);
            gl.deleteShader(program.vs);
            gl.deleteShader(program.fs);
            gl.bindAttribLocation(program, 0, "vertex");
            gl.linkProgram(program);
            gl.useProgram(program);
            console.log(program);

            function getShader(gl, id) {
                var shaderScript = document.getElementById(id);
                if (!shaderScript) {
                    return null;
                }

                var str = "";
                var k = shaderScript.firstChild;
                while (k) {
                    if (k.nodeType == 3) {
                        str += k.textContent;
                    }
                    k = k.nextSibling;
                }

                var shader;
                if (shaderScript.type == "x-shader/x-fragment") {
                    shader = gl.createShader(gl.FRAGMENT_SHADER);
                } else if (shaderScript.type == "x-shader/x-vertex") {
                    shader = gl.createShader(gl.VERTEX_SHADER);
                } else {
                    return null;
                }
                gl.shaderSource(shader, str);
                gl.compileShader(shader);
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    alert(gl.getShaderInfoLog(shader));
                    return null;
                }
                return shader;
            }

            function initWebGL(canvas) {
                var gl = null;
                var msg = "Your browser does not support WebGL, "+"or it is not enabled by default.";

                try{
                    gl = canvas.getContext("experimental-webgl");
                }

                catch (e){
                    msg = "Error creating WebGL Context!: " + e.toString();
                }

                if (!gl){
                    alert(msg);
                    throw new Error(msg);
                }
                return gl;
             }

            function initViewport(gl, canvas)
            {
                    gl.viewport(canvas.width, canvas.height, 0, 0);
            }

            pnacl.addEventListener('loadstart', log_handler("loadstart"));
            pnacl.addEventListener('progress', log_handler("progress"));
            pnacl.addEventListener('load', log_handler("load"));
            pnacl.addEventListener('error', log_handler("error"));
            pnacl.addEventListener('abort', log_handler("abort"));
            pnacl.addEventListener('loadend', log_handler("loadend"));

            // The 'error' and 'abort' events get a descriptive error message:
            function error_handler() {
                console.error("Error occurred:", pnacl.lastError);
            }
            pnacl.addEventListener('error', error_handler);
            pnacl.addEventListener('abort', error_handler);

            function handleMessage(ev){
                //output.textContent += ev.data;
                //console.log(ev);
                console.log(ev.data);
                //typeof(ev.data);
                    //console.log(ev.data.byteLength);
                    view   = new Uint8Array(ev.data);
                    gl.texImage2D(
                        gl.TEXTURE_2D, // target
                        0, // mip level
                        gl.RGBA, // internal format
                        w, h, // width and height
                        0, // border
                        gl.RGBA, //format
                        gl.UNSIGNED_BYTE, // type
                        view // texture data
                    );
                    gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
                    gl.bufferData(gl.ARRAY_BUFFER, 
                                  new Float32Array([-1, -1,
                                   1, -1,
                                   1, 1,               
                                   1, 1,
                                   -1, 1,
                                   -1, -1]), gl.STATIC_DRAW);
                    /*program.vs = gl.createShader(gl.VERTEX_SHADER);
                    gl.shaderSource(program.vs,
                                    "attribute vec4 vertex;\n" +
                                    "varying vec2 tc;\n" +
                                    "void main(){\n" +
                                    " gl_Position = vertex;\n" +
                                    " tc = vertex.xy*0.5+0.5;\n" +
                                    "}\n");
                    program.fs = gl.createShader(gl.FRAGMENT_SHADER);
                    gl.shaderSource(program.fs,
                                    "precision highp float;\n" +
                                    "uniform sampler2D tex;\n" +
                                    "varying vec2 tc;\n" +
                                    "void main(){\n" +
                                    " gl_FragColor = texture2D(tex, tc);\n" +
                                    "}\n");
                    gl.compileShader(program.vs);
                    gl.compileShader(program.fs);*/
                    /*gl.attachShader(program,program.vs);
                    gl.attachShader(program,program.fs);
                    gl.deleteShader(program.vs);
                    gl.deleteShader(program.fs);
                    gl.bindAttribLocation(program, 0, "vertex");
                    gl.linkProgram(program);
                    gl.useProgram(program);*/
                    gl.enableVertexAttribArray(0);
                    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                    gl.drawArrays(gl.TRIANGLES, 0, 6);
            };



            pnacl.addEventListener('message', handleMessage, true);
            pnacl.addEventListener('crash', function () {
                console.log("Exit code:", pnacl.exitStatus);
            });

            pnacl.addEventListener('load', function(ev){
                setTimeout(function(){
                    pnacl.postMessage("Message from html: Run 1, 2, 3");
                    console.log("posted message");
                },500);
            });
        </script>
    </body>
</html>